# EMS 售前调研工具系统运维手册

## 1. 系统架构
EMS 售前调研工具采用前后端分离的架构，前端使用 React + TypeScript 开发，后端使用 Supabase 作为 BaaS (Backend as a Service) 平台，提供数据库、认证和API服务。

### 1.1 架构组件
- **前端应用**：React + TypeScript + Vite
- **后端服务**：Supabase (PostgreSQL 数据库 + 认证服务)
- **API 集成**：Google Gemini API (用于报告生成)
- **部署平台**：可部署在任何支持静态网站托管的平台

### 1.2 数据流
1. 用户通过浏览器访问前端应用
2. 前端应用通过 Supabase Client SDK 与 Supabase 服务通信
3. Supabase 处理数据库操作和用户认证
4. 对于报告生成等复杂任务，前端调用 Google Gemini API
5. 数据和操作结果返回给前端，展示给用户

### 1.3 技术栈
| 类别 | 技术/服务 | 版本 | 用途 |
|------|-----------|------|------|
| 前端框架 | React | 19.2.4 | 构建用户界面 |
| 编程语言 | TypeScript | 5.8.2 | 类型安全的 JavaScript 超集 |
| 构建工具 | Vite | 6.2.0 | 前端构建和开发服务器 |
| 状态管理 | React Context API | - | 组件状态管理 |
| 路由 | React Router | 7.13.0 | 前端路由管理 |
| 图表库 | Recharts | 3.7.0 | 数据可视化 |
| 后端服务 | Supabase | - | 数据库和认证服务 |
| 数据库 | PostgreSQL | - | 数据存储 |
| AI 服务 | Google Gemini API | - | 报告生成 |

## 2. 系统部署
### 2.1 环境要求
- **前端开发环境**：
  - Node.js 18.0+ 
  - npm 9.0+ 或 yarn 1.22+ 
  - Git
- **后端环境**：
  - Supabase 项目 (免费或付费计划)
- **部署平台**：
  - Vercel、Netlify、GitHub Pages 等静态网站托管服务

### 2.2 部署步骤

#### 2.2.1 Supabase 配置
1. **创建 Supabase 项目**：
   - 访问 [Supabase 控制台](https://app.supabase.com)
   - 点击 "New Project" 创建新项目
   - 填写项目名称、选择地区、设置数据库密码
   - 点击 "Create Project" 完成创建

2. **配置环境变量**：
   - 在项目设置中找到 "API" 部分
   - 复制 "Project URL" 和 "Anon public" 密钥
   - 在前端项目中创建 `.env.local` 文件，填入以下内容：
     ```
     VITE_SUPABASE_URL="https://your-project.supabase.co"
     VITE_SUPABASE_ANON_KEY="your-anon-key"
     ```

3. **初始化数据库**：
   - 在 Supabase 控制台中进入 "SQL Editor"
   - 复制 `supabase-init.sql` 文件的内容
   - 粘贴到 SQL Editor 中，点击 "Run" 执行
   - 等待脚本执行完成，创建数据表和初始化数据

#### 2.2.2 前端部署
1. **构建前端应用**：
   - 在本地项目目录中执行：
     ```bash
     npm install
     npm run build
     ```
   - 构建完成后，会在 `dist` 目录生成静态文件

2. **部署到静态网站托管服务**：
   - **Vercel**：
     - 登录 Vercel 控制台
     - 点击 "New Project"
     - 选择前端项目的 Git 仓库
     - 配置环境变量 (与 `.env.local` 相同)
     - 点击 "Deploy" 完成部署
   
   - **Netlify**：
     - 登录 Netlify 控制台
     - 点击 "Add new site" → "Import an existing project"
     - 选择前端项目的 Git 仓库
     - 配置构建命令为 `npm run build`，发布目录为 `dist`
     - 配置环境变量
     - 点击 "Deploy site" 完成部署
   
   - **Cloudflare Pages**：
     - 登录 Cloudflare 控制台
     - 点击 "Pages" → "Create a project"
     - 选择前端项目的 Git 仓库
     - 配置构建参数：
       - 框架预设：React
       - 构建命令：`npm run build`
       - 构建输出目录：`dist`
     - 配置环境变量 (与 `.env.local` 相同)
     - 点击 "Save and Deploy" 完成部署
     - 部署完成后，Cloudflare 会分配一个默认域名，也可以配置自定义域名

### 2.3 自定义域名
1. **在托管服务中配置**：
   - 在 Vercel 或 Netlify 中进入项目设置
   - 找到 "Domains" 或 "Custom domains" 部分
   - 添加自定义域名
   - 按照提示完成 DNS 配置

2. **SSL 证书**：
   - 大多数托管服务会自动为自定义域名生成 SSL 证书
   - 确保证书状态为 "Valid" 或 "Active"

## 3. 配置管理
### 3.1 环境变量
| 变量名 | 类型 | 描述 | 默认值 | 必要性 |
|--------|------|------|--------|--------|
| VITE_SUPABASE_URL | string | Supabase 项目 URL | - | 必需 |
| VITE_SUPABASE_ANON_KEY | string | Supabase 匿名访问密钥 | - | 必需 |
| VITE_APP_NAME | string | 应用名称 | "EMS 售前调研工具" | 可选 |
| VITE_API_URL | string | API 基础 URL | "http://localhost:3000/api" | 可选 |
| VITE_GEMINI_API_KEY | string | Google Gemini API 密钥 | - | 可选（用于报告生成） |

### 3.2 配置文件
- **.env.local**：本地开发环境配置
- **.env.production**：生产环境配置（部署时使用）
- **src/config/supabase.ts**：Supabase 客户端配置
- **vite.config.ts**：Vite 构建配置

### 3.3 配置管理最佳实践
- 使用环境变量管理敏感信息，避免硬编码
- 不同环境使用不同的配置文件
- 使用版本控制管理配置文件模板，但不要提交包含敏感信息的实际配置文件
- 定期检查和更新配置，确保系统安全

## 4. 系统监控
### 4.1 前端监控
- **错误监控**：
  - 集成 Sentry 或 LogRocket 监控前端错误
  - 配置错误报警机制

- **性能监控**：
  - 使用 Google Analytics 或 Vercel Analytics 监控页面加载性能
  - 定期分析性能指标，优化前端代码

### 4.2 后端监控
- **Supabase 监控**：
  - 在 Supabase 控制台查看数据库性能和使用情况
  - 监控 API 请求次数和错误率
  - 配置数据库备份策略

- **数据库监控**：
  - 监控数据库连接数和查询性能
  - 定期分析慢查询，优化数据库索引

### 4.3 日志管理
- **系统日志**：
  - 前端应用的操作日志存储在 `system_logs` 表中
  - 可通过系统日志页面查看和分析

- **错误日志**：
  - 前端错误可通过浏览器控制台查看
  - 后端错误可通过 Supabase 控制台查看

### 4.4 告警机制
- **配置邮件告警**：
  - 在 Supabase 控制台配置重要事件的邮件通知
  - 监控系统关键指标，设置阈值告警

- **定期检查**：
  - 每周检查系统日志和监控数据
  - 每月生成系统健康报告

## 5. 系统维护
### 5.1 定期维护任务
| 任务 | 频率 | 描述 | 负责人 |
|------|------|------|--------|
| 数据库备份 | 每日 | 备份 Supabase 数据库 | 系统管理员 |
| 系统日志清理 | 每月 | 清理过期的系统日志 | 系统管理员 |
| 性能优化 | 季度 | 优化前端代码和数据库查询 | 开发团队 |
| 安全审计 | 半年 | 检查系统安全漏洞 | 安全团队 |
| 依赖更新 | 季度 | 更新前端依赖包 | 开发团队 |

### 5.2 数据维护
- **数据备份**：
  - 使用 Supabase 的自动备份功能
  - 定期导出数据库为 SQL 文件，存储在安全位置

- **数据清理**：
  - 定期清理过期的调研表单和报告
  - 归档不再活跃的用户数据

- **数据迁移**：
  - 在系统升级时，确保数据平滑迁移
  - 测试数据迁移脚本，避免数据丢失

### 5.3 安全维护
- **密码策略**：
  - 强制用户使用强密码
  - 定期提醒用户修改密码

- **权限管理**：
  - 定期审查用户权限，移除不必要的权限
  - 遵循最小权限原则

- **漏洞修复**：
  - 及时更新依赖包，修复已知漏洞
  - 定期扫描系统安全漏洞

### 5.4 版本管理
- **代码版本控制**：
  - 使用 Git 进行代码版本控制
  - 遵循语义化版本规范

- **发布流程**：
  - 开发 → 测试 → 预发布 → 生产
  - 每次发布前进行充分测试

- **回滚策略**：
  - 准备回滚方案，以防发布失败
  - 测试回滚流程，确保能够快速恢复

## 6. 故障排查
### 6.1 常见问题
| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 登录失败 | 用户名或密码错误 | 检查用户名和密码，联系管理员重置 |
| 页面加载缓慢 | 网络问题或前端代码优化不足 | 检查网络连接，优化前端代码 |
| 数据加载失败 | Supabase 连接问题 | 检查网络连接和 Supabase 服务状态 |
| 报告生成失败 | Gemini API 密钥无效或配额不足 | 检查 API 密钥，申请更多配额 |
| 权限错误 | 用户权限不足 | 联系管理员分配适当的权限 |
| 数据库错误 | SQL 语法错误或约束违反 | 检查数据输入，联系开发团队 |

### 6.2 排查步骤
1. **前端问题排查**：
   - 打开浏览器开发者工具 (F12)
   - 查看控制台 (Console) 中的错误信息
   - 检查网络 (Network) 请求和响应
   - 确认环境变量配置正确

2. **后端问题排查**：
   - 登录 Supabase 控制台
   - 查看 "Database" → "Logs" 中的数据库日志
   - 检查 "Authentication" → "Users" 中的用户状态
   - 验证 API 密钥和权限设置

3. **API 集成问题排查**：
   - 检查 API 密钥是否有效
   - 验证 API 调用参数是否正确
   - 查看 API 服务的状态和配额

### 6.3 紧急故障处理
1. **服务中断**：
   - 确认问题范围和影响
   - 检查 Supabase 服务状态
   - 尝试回滚到之前的稳定版本
   - 联系 Supabase 支持团队（如果是 Supabase 服务问题）

2. **数据丢失**：
   - 立即停止所有写入操作
   - 从最近的备份恢复数据
   - 验证恢复的数据完整性
   - 分析数据丢失原因，防止再次发生

3. **安全事件**：
   - 隔离受影响的系统组件
   - 撤销泄露的 API 密钥和凭证
   - 通知相关用户和安全团队
   - 记录事件详情，制定改进措施

## 7. 系统升级
### 7.1 前端升级
1. **依赖更新**：
   - 执行 `npm outdated` 查看过时的依赖
   - 执行 `npm update` 更新补丁版本
   - 对于主要版本更新，需要手动修改 `package.json` 并测试兼容性

2. **代码更新**：
   - 拉取最新的代码变更
   - 解决可能的合并冲突
   - 执行 `npm install` 安装新依赖
   - 执行 `npm run build` 验证构建成功

3. **部署更新**：
   - 测试环境部署和验证
   - 生产环境部署
   - 监控部署后的系统状态

### 7.2 后端升级
1. **Supabase 更新**：
   - 关注 Supabase 的更新公告
   - 测试新功能和变更在开发环境中的兼容性
   - 应用必要的配置变更

2. **数据库迁移**：
   - 编写数据库迁移脚本
   - 在测试环境执行迁移并验证
   - 在生产环境执行迁移
   - 监控迁移后的数据库性能

3. **API 版本管理**：
   - 遵循语义化版本规范
   - 为破坏性变更提供迁移路径
   - 更新 API 文档

### 7.3 升级测试
1. **功能测试**：
   - 测试所有核心功能
   - 验证数据完整性
   - 检查用户权限

2. **性能测试**：
   - 测量页面加载时间
   - 测试数据库查询性能
   - 验证系统响应时间

3. **兼容性测试**：
   - 测试主流浏览器兼容性
   - 验证不同设备和屏幕尺寸
   - 检查第三方服务集成

## 8. 系统备份与恢复
### 8.1 备份策略
- **数据库备份**：
  - Supabase 自动每日备份（免费计划保留 7 天，付费计划保留更长时间）
  - 手动导出 SQL 备份，存储在安全位置
  - 关键数据定期导出为 CSV 格式

- **代码备份**：
  - Git 版本控制
  - 远程代码仓库（GitHub、GitLab、Bitbucket）
  - 定期代码仓库备份

- **配置备份**：
  - 环境变量配置文件备份
  - 系统配置文件备份
  - 部署配置备份

### 8.2 恢复流程
1. **数据库恢复**：
   - 从 Supabase 控制台的 "Database" → "Backups" 恢复
   - 对于手动备份，使用 SQL 导入功能恢复
   - 验证恢复的数据完整性

2. **应用恢复**：
   - 从 Git 仓库拉取最新代码
   - 重新构建和部署前端应用
   - 配置环境变量

3. **灾难恢复**：
   - 制定详细的灾难恢复计划
   - 定期测试恢复流程
   - 确保恢复时间在可接受范围内

## 9. 监控与告警
### 9.1 监控指标
| 指标 | 描述 | 阈值 | 告警方式 |
|------|------|------|----------|
| 页面加载时间 | 前端页面加载完成时间 | > 3秒 | 邮件通知 |
| API 响应时间 | Supabase API 响应时间 | > 1秒 | 邮件通知 |
| 错误率 | 前端或 API 错误率 | > 5% | 邮件通知 |
| 数据库连接数 | 活跃的数据库连接数 | > 80% 最大连接数 | 邮件通知 |
| 存储使用量 | Supabase 存储使用量 | > 80% 配额 | 邮件通知 |
| 用户登录失败率 | 登录失败次数与尝试次数的比率 | > 10% | 邮件通知 |

### 9.2 监控工具
- **前端监控**：
  - Google Analytics
  - Sentry
  - LogRocket

- **后端监控**：
  - Supabase 内置监控
  - PostgreSQL 监控工具

- **基础设施监控**：
  - UptimeRobot (服务可用性监控)
  - Pingdom (网站性能监控)

### 9.3 告警配置
1. **邮件告警**：
   - 配置系统管理员的邮件地址
   - 为不同级别的告警设置不同的邮件模板
   - 确保告警邮件能够及时送达

2. **短信告警**：
   - 对于严重故障，配置短信告警
   - 限制短信告警的频率，避免告警风暴

3. **告警升级**：
   - 建立告警升级流程
   - 对于未及时处理的告警，自动升级到更高级别的管理人员

## 10. 安全管理
### 10.1 安全策略
- **身份认证**：
  - 使用 Supabase 的认证系统
  - 支持邮箱/密码登录
  - 考虑添加多因素认证（MFA）

- **授权**：
  - 基于角色的访问控制（RBAC）
  - 使用 Supabase 的 Row Level Security (RLS) 保护数据
  - 最小权限原则

- **数据保护**：
  - 敏感数据加密存储
  - 传输过程使用 HTTPS
  - 定期数据备份

- **API 安全**：
  - API 密钥安全管理
  - 速率限制，防止暴力攻击
  - API 调用审计

### 10.2 安全审计
1. **定期审计**：
   - 每半年进行一次全面的安全审计
   - 检查用户权限和访问日志
   - 扫描系统漏洞

2. **合规性检查**：
   - 确保系统符合相关的数据保护法规
   - 保留必要的审计日志
   - 制定数据泄露响应计划

3. **安全培训**：
   - 为系统管理员和用户提供安全培训
   - 定期更新安全最佳实践
   - 提高安全意识

### 10.3 安全事件响应
1. **事件识别**：
   - 监控系统异常行为
   - 建立安全事件报告机制
   - 快速评估事件严重性

2. **事件响应**：
   - 组建安全响应团队
   - 执行事件响应计划
   - 隔离受影响的系统

3. **事件恢复**：
   - 从备份恢复系统
   - 修复安全漏洞
   - 验证系统安全状态

4. **事后分析**：
   - 记录事件详情和响应过程
   - 分析事件原因和改进点
   - 更新安全策略和程序

## 11. 附录
### 11.1 常用命令
| 命令 | 描述 | 示例 |
|------|------|------|
| npm install | 安装依赖 | `npm install` |
| npm run dev | 启动开发服务器 | `npm run dev` |
| npm run build | 构建生产版本 | `npm run build` |
| npm run preview | 预览生产构建 | `npm run preview` |
| npm run lint | 运行 TypeScript 类型检查 | `npm run lint` |
| git clone | 克隆代码仓库 | `git clone <repository-url>` |
| git pull | 拉取最新代码 | `git pull origin main` |
| git push | 推送代码变更 | `git push origin main` |

### 11.2 配置文件模板
#### .env.local 模板
```env
# Supabase连接信息
VITE_SUPABASE_URL="https://your-project.supabase.co"
VITE_SUPABASE_ANON_KEY="your-anon-key"

# 其他环境变量
VITE_APP_NAME="EMS 售前调研工具"
VITE_API_URL="http://localhost:3000/api"

# Google Gemini API 密钥（可选）
VITE_GEMINI_API_KEY="your-gemini-api-key"
```

### 11.3 故障排查清单
- [ ] 检查网络连接
- [ ] 验证环境变量配置
- [ ] 检查 Supabase 服务状态
- [ ] 查看浏览器控制台错误
- [ ] 检查数据库连接和查询
- [ ] 验证 API 密钥和权限
- [ ] 检查系统日志
- [ ] 尝试清除浏览器缓存
- [ ] 测试在不同浏览器中的行为
- [ ] 检查依赖版本兼容性

### 11.4 支持资源
- **Supabase 文档**：https://supabase.com/docs
- **React 文档**：https://react.dev/docs
- **TypeScript 文档**：https://www.typescriptlang.org/docs
- **Vite 文档**：https://vitejs.dev/guide
- **Google Gemini API 文档**：https://ai.google.dev/docs

### 11.5 联系信息
| 角色 | 姓名 | 邮箱 | 电话 |
|------|------|------|------|
| 系统管理员 | - | admin@example.com | - |
| 开发团队 | - | dev@example.com | - |
| 技术支持 | - | support@example.com | - |

---

**版本信息**：
- 文档版本：v1.0.0
- 发布日期：2024-05-20
- 最后更新：2024-05-20

**备注**：本运维手册将根据系统的更新和变更进行定期修订，请使用最新版本。
